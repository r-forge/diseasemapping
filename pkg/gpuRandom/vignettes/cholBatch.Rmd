<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{cholBatch}
-->


## Chol
```{r package}
#library(Matrix)

```


```{r cpu_function}
a1 = matrix(c(25,15,-5,15,18,0,-5,0,11),nrow=3,ncol=3,byrow=TRUE)
x <- chol(a1)   ## start from factor given by chol
y <- diag(x)   ## extract sqrt(D)
L1 <- t(x/y)     ## get unit lower triangular factor
D1 <- diag(x^2)  ## and diagonal


a2 = matrix(c(2,5,-5,5,16,3,-5,3,85),nrow=3,ncol=3, byrow=TRUE)
x <- chol(a2)   ## start from factor given by chol
y <- diag(x)   ## extract sqrt(D)
L2 <- t(x/y)     ## get unit lower triangular factor
D2 <- diag(x^2)  ## and diagonal


A1 = cbind(c(0,0,0,0), rbind(c(0,0,0),a1))  #4x4
A2 = cbind(c(0,0,0,0), rbind(c(0,0,0),a2))

rbind(A1,A2)
L1;D1;L2;D2

gpuA<-vclMatrix(rbind(A1,A2),type="float")


## So now A = LDL'
```

```{r chol_two_batch}
diagMat = vclMatrix(0, 3, ncol(A1), type = "float")
NglobalChol =  c(4,4,0)
NlocalChol = c(2,2,0)
NlocalCache = 100
gpuRandom:::cholBatchBackend(gpuA, diagMat, c(1,3,1,3), c(1,2,0,3), 2L,
                             NglobalChol, NlocalChol, NlocalCache)

as.matrix(gpuA)
as.matrix(diagMat)
```


```{r chol_R_function}
rbind(a1,a2)
a<-vclMatrix(rbind(a1,a2),type="float")
diagMat = vclMatrix(0, 2, ncol(a1), type = "float")
result<-gpuRandom::cholBatch(a, diagMat, numbatchD=2L,
                            Nglobal=NglobalChol, Nlocal=NlocalChol, NlocalCache=NlocalCache)

L1;D1;L2;D2
as.matrix(a)
as.matrix(diagMat)
```



```{r crossprodbatch2, eval=TRUE}
a1 = matrix(1:160,40,4)
a2=matrix(2:161,40,4)
A=rbind(a1,a2,a1,a2)
d1 <- matrix(0,nrow=nrow(a1), ncol=nrow(a1))
diag(d1)<-1:nrow(a1)
d2 <- matrix(0,nrow=nrow(a2), ncol=nrow(a2))
diag(d2)<-1:nrow(a2)

result<-rbind(t(a1)%*% d1%*%a1,t(a2)%*% d2%*%a2,t(a1)%*% d1%*%a1,t(a2)%*% d2%*%a2)

D<-rbind(diag(d1),diag(d2),diag(d1),diag(d2))

library(gpuR)
gpuC<-vclMatrix(0, nrow=ncol(A)*4, ncol=ncol(A),type="double")
gpuA<-vclMatrix(A,type="double")
gpuD<-vclMatrix(D, nrow=nrow(D),ncol=ncol(D),type='double')
gpuRandom:::crossprodBatchBackend(gpuC,gpuA,gpuD,invertD=FALSE,
                                  Nglobal=c(16,16,1), 
                                  Nlocal = c(2,2,1), 
                                  NlocalCache=50)

cbind(as.matrix(gpuC), NA,  result)













a1 = matrix(1:72,6,9)
a2=matrix(2:73,6,9)
A=rbind(a1,a2,a1,a2)
d1 <- matrix(0,nrow=nrow(a1), ncol=nrow(a1))
diag(d1)<-1:nrow(a1)
d2 <- matrix(0,nrow=nrow(a2), ncol=nrow(a2))
diag(d2)<-1:nrow(a2)

result<-rbind(t(a1)%*% d1%*%a1,t(a2)%*% d2%*%a2,t(a1)%*% d1%*%a1,t(a2)%*% d2%*%a2)

D<-rbind(diag(d1),diag(d2),diag(d1),diag(d2))

library(gpuR)
gpuC<-vclMatrix(0, nrow=ncol(A)*4, ncol=ncol(A),type="double")
gpuA<-vclMatrix(A,type="double")
gpuD<-vclMatrix(D, nrow=nrow(D),ncol=ncol(D),type='double')
gpuRandom:::crossprodBatchBackend(gpuC,gpuA,gpuD,invertD=FALSE,
                                  Nglobal=c(16,16,1), 
                                  Nlocal = c(2,2,1), 
                                  NlocalCache=50)

cbind(as.matrix(gpuC), NA,  result)
```

```{r crossprodbatch_square, eval=TRUE}
a1 = matrix(1:16,4,4)
a2=matrix(2:17,4,4)
A=rbind(a1,a2,a1,a2)
d1 <- matrix(0,nrow=nrow(a1), ncol=nrow(a1))
diag(d1)<-1:nrow(a1)
d2 <- matrix(0,nrow=nrow(a2), ncol=nrow(a2))
diag(d2)<-1:nrow(a2)

result<-rbind(t(a1)%*% d1%*%a1,t(a2)%*% d2%*%a2,t(a1)%*% d1%*%a1,t(a2)%*% d2%*%a2)

D<-rbind(diag(d1),diag(d2),diag(d1),diag(d2))

library(gpuR)
gpuC<-vclMatrix(0, nrow=ncol(A)*4, ncol=ncol(A),type="double")
gpuA<-vclMatrix(A,type="double")
gpuD<-vclMatrix(D, nrow=nrow(D),ncol=ncol(D),type='double')
gpuRandom:::crossprodBatchBackend(gpuC,gpuA,gpuD,invertD=FALSE,
                                  Nglobal=c(16,16,1), 
                                  Nlocal = c(2,2,1), 
                                  NlocalCache=50)

cbind(as.matrix(gpuC), NA,  result)
```


```{r crossprodbatch_rectangular, eval=TRUE}
D <- matrix(0,nrow=3, ncol=3)
diag(D)<-c(1,8,3)
D
A = matrix(c(1,0,0,0,1,0),nrow=3,ncol=2, byrow=T)
A
result<- t(A)%*% D%*%A
result
gpuC<-vclMatrix(0, nrow=2, ncol=2,type="float")
gpuA2<-vclMatrix(A,type="float")
gpuD<-vclMatrix(diag(D), nrow=1,ncol=3,type='float')
gpuRandom:::crossprodBatchBackend(gpuC,gpuA2,gpuD,invertD=F, c(1,1,1),c(1,1,1), 1000)
as.matrix(gpuC)
```


```{r crossprodbatch_more, eval=TRUE}
D <- matrix(0,nrow=40, ncol=40)
diag(D)<-c(1:40)
a = matrix(1:40,nrow=40,ncol=1, byrow=T)
A=rbind(a,a,a,a)
result<- t(a)%*% D%*%a
result
gpuC<-vclMatrix(0, nrow=4, ncol=1,type="float")
gpuA<-vclMatrix(A,type="float")
gpuD<-vclMatrix(rbind(diag(D),diag(D),diag(D),diag(D)), nrow=4,ncol=40,type='float')
gpuRandom:::crossprodBatchBackend(gpuC,gpuA,gpuD,invertD=F, NglobalChol,NlocalChol, NlocalCache)
as.matrix(gpuC)


gpuC2<-vclMatrix(0, nrow=1, ncol=1,type="float")
gpuA2<-vclMatrix(a,type="float")
gpuD2<-vclMatrix(diag(D), nrow=1,ncol=40,type='float')
gpuRandom:::crossprodBatchBackend(gpuC2,gpuA2,gpuD2,invertD=F, NglobalChol,NlocalChol, NlocalCache)
as.matrix(gpuC2)




```






