<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{backsolveBatch}
-->


```{r setup, include=FALSE}
library('gpuR')
```


## backsolve function test
```{r  ABC}

a1 = matrix( c(1, 0.5,0.5,0.5, 1,0.5, 0.5, 0.5, 1), nrow=3, ncol=3, byrow = TRUE) 
a2 = matrix( c(1, 0.5,0.5,0.5, 1,0.5, 0.5, 0.5, 1), nrow=3, ncol=3, byrow = TRUE) 
A1 = cbind(c(1,2,4,7), rbind(a1,c(4,5,1)))
A2 = cbind(c(4,1,8,6), rbind(a1,c(2,9,3)))
C1 = matrix( c(2, 4, 3, 1, 5, 7), nrow=3, ncol=2, byrow=F) 
C2 = matrix( c(1, 5, 30, 12, 2, 17), nrow=3, ncol=2,byrow=F)  

B1 = a1%*%C1
B2= a2%*%C2
BN1 <- rbind(c(2,3,4,5), cbind(c(1,2,3),B1,c(2,3,4)), c(1,6,5,3))
BN1
BN2 <- rbind(c(2,6,8,6), cbind(c(1,2,3),B2,c(5,3,1)), c(1,2,51,2))
BN2
A <- rbind(A1,A2)
A
B <- rbind(BN1,BN2)
B
C <- rbind(C1,C2)
C
gpuA <- vclMatrix(A, type="double")
gpuB <- vclMatrix(B, type="double")
gpuC <- vclMatrix(0,nrow=6, ncol=3, type="double")
```

## test

```{r backsolve}
NlocalCache = 0
Nglobal = c(8L, 8L, 8L)
Nlocal = c(4L, 2L)
gpuRandom:::backsolveBatchBackend(gpuC, gpuA, gpuB, 
                                  c(0,2,0,1),c(0,2,1,3),c(1,3,1,2),2L,
                                  diagIsOne=T, Nglobal, Nlocal, NlocalCache)
as.matrix(gpuC)

```


```{r testP}
N = 5

Amat = vclMatrix(rbind(diag(N), diag(N), diag(N),
                       diag(N) + as.matrix(0.1*Matrix::bandSparse(N,N,-1))),
                 type='double')
Nmatrix = nrow(Amat)/ncol(Amat)
Bmat = vclMatrix(cbind(rep(c(1,0), c(1, N-1)),
             rep(1,N)), type='double')
Cmat = vclMatrix(0, nrow(Amat), ncol(Bmat), type='double')
as.matrix(Amat)
as.matrix(Bmat)

NlocalCache = 2 # breaks if NlocalCache < N
Nglobal = c(4L, 4L, 4L)
Nlocal = c(2L, 2L) 
gpuRandom:::backsolveBatchBackend(Cmat, Amat, Bmat, 
                                  c(0,N,0,ncol(Bmat)),
                                  c(0,N,0,N),
                                  c(0,N,0,ncol(Bmat)),
                                  1L,
                                  diagIsOne=FALSE, 
                                  Nglobal, Nlocal, NlocalCache)
for(D in 1:Nmatrix) {
print(cbind(
  as.matrix(Amat)[(D-1)*N + 1:N, ], NA,
#  as.matrix(Bmat), NA,
  as.matrix(Cmat)[(D-1)*N + 1:N,], NA,
  solve(as.matrix(Amat)[(D-1)*N + 1:N, ]) %*% as.matrix(Bmat)))
}
```
