<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{crossprodBatch}
-->


```{r setup, include=FALSE}
library('gpuR')
```


```{r crossprodbatch_more, eval=F}
D <- matrix(0,nrow=5, ncol=5)
diag(D)<-c(1:5)
D
a = matrix(1:15,nrow=5,ncol=3, byrow=T)
a
result<- t(a)%*% D%*%a
result     # 3x3


zerorow=integer(3)
zerocol=integer(7)
A= cbind(zerocol,rbind(zerorow,a,zerorow))

Nglobal = c(16,8) 
Nlocal = c(2, 2)
NlocalCache = 40


gpuC<-vclMatrix(0, nrow=12, ncol=6,type="float")   
gpuA<-vclMatrix(rbind(A,A),type="float")
gpuD<-vclMatrix(rbind(diag(D),diag(D)), nrow=2,ncol=nrow(D),type='float')
gpuRandom:::crossprodBatchBackend(gpuC,gpuA,gpuD,invertD=F, 
                                  c(1,3,1,3),
                                  c(1,5,1,3),
                                  c(0,1,0,5),
                                  Nglobal,Nlocal, NlocalCache)
as.matrix(gpuC)



gpuC2<-vclMatrix(0, nrow=1, ncol=1,type="float")
gpuA2<-vclMatrix(a,type="float")
gpuD2<-vclMatrix(diag(D), nrow=1,ncol=40,type='float')
gpuRandom:::crossprodBatchBackend(gpuC2,gpuA2,gpuD2,invertD=F, NglobalChol,NlocalChol, NlocalCache)
as.matrix(gpuC2)

```


```{r checkAug26}



D1 <- matrix(0,nrow=7, ncol=7)
diag(D1)<-c(1,2,3,4,5,6,7)
D1
a = matrix(rep(1,21),nrow=7,ncol=3, byrow=T)
#a
result<- t(a)%*% D1%*%a
result     # 3x3
D2 <- matrix(0,nrow=7, ncol=7)
diag(D2)<-c(1,1,1,1, 1.66, 1, 1)
#D2
result2<- t(a)%*% D2%*%a
result2

gpuC<-vclMatrix(0, nrow=21, ncol=3,type="double")   
gpuA<-vclMatrix(rbind(a,a,a,a,a,a,a),type="double")
gpuD<-vclMatrix(rbind(diag(D1),diag(D2),diag(D1),diag(D2),diag(D1),diag(D2),diag(D1)), nrow=7,ncol=nrow(D2),type='double')

gpuRandom::crossprodBatch(gpuC, 
                          gpuA,
                          gpuD,
                          invertD = FALSE,
                          Nglobal = c(64, 16), 
                          Nlocal =  c(32, 8),
                          NlocalCache = 3)

as.matrix(gpuC)


gpuRandom::crossprodBatch(gpuC, 
                          gpuA,
                          gpuD,
                          invertD = TRUE,
                          Nglobal = c(1,1), 
                          Nlocal = c(1, 1),
                          NlocalCache = 40)

as.matrix(gpuC)



gpuC<-vclMatrix(0, nrow=3, ncol=3,type="double")   
gpuA<-vclMatrix(rbind(a),type="double")
gpuD<-vclMatrix(rbind(diag(D2)), nrow=2,ncol=nrow(D2),type='double')

gpuRandom::crossprodBatch(gpuC, 
                          gpuA,
                          gpuD,
                          invertD = FALSE,
                          Nglobal = c(2,2), 
                          Nlocal = c(1, 1),
                          NlocalCache = 40)

as.matrix(gpuC)















gpuRandom:::crossprodBatchBackend(gpuC,gpuA,gpuD,invertD=F, 
                                  c(1,3,1,3),
                                  c(1,5,1,3),
                                  c(0,1,0,5),
                                  Nglobal,Nlocal, NlocalCache)
as.matrix(gpuC)





```


