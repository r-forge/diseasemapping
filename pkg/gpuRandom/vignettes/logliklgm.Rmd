<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{loglikelihood_lgm}
-->


```{r test_on_cpu, message=FALSE, eval=T}
library(gpuR)
library(geostatsp)
set.seed(1)
n=20
mydat = SpatialPointsDataFrame(cbind(stats::runif(n), seq(0,1,len=n)),
                               data=data.frame(cov1 = rnorm(n), cov2 = rpois(n, 2)))

# simulate a random field
mydat@data= cbind(mydat@data , RFsimulate(model=c(variance=1.5,range=0.5,nugget=0.25,shape=1.25,anisoRatio = 1, anisoAngleRadins=0),x=mydat)@data)

# add fixed effects
mydat$Y = -3 + 0.5*mydat$cov1 + 0.2*mydat$cov2 + mydat$sim + rnorm(length(mydat), 0, sd=sqrt(0.25))

dist(mydat@coords)
# fit the model
myres = likfitLgm(
	formula=Y ~ cov1 + cov2, 
	data=mydat, 
	param=c(variance=1.5,range=0.5, shape=1.25, nugget=0.25), reml=FALSE)
#variance parameter and regression coefficients are always estimated even if not listed.
# produces mles of parameters
myres$parameters
myres$summary[c("(Intercept)","cov1","cov2"),1] 


# calculate log-likelihood
temp0=loglikLgm(param=myres$parameters, 
		data=mydat, 
		formula = Y ~ cov1 + cov2,
		reml=FALSE, minustwotimes=TRUE)
temp0
#minusTwoLogLik 
#      52.20254 

#52.20254-56.21288=-4.01034


 #53.73501 -72.85779 = -19.12278

```



```{r test on gpu, eval=T}
paramsBatch = rbind(c(shape=1.25, range=0.2641423, variance = 1.5, nugget = 0, anisoRatio = 1, anisoAngleRadians = 0),
                    c(shape=1.25, range=0.5, variance = 1.5, nugget = 0.25, anisoRatio = 1, anisoAngleRadians = 0),
                    c(shape=2.25, range=0.5, variance = 2.5, nugget = 2.25, anisoRatio = 1, anisoAngleRadians = 0))
 # c(shape=1.25, range=0.5, variance = 1.5, nugget = 0.25, anisoRatio = 1, anisoAngleRadians = 0))
#paramsBatch = rbind(c(shape=3, range=11.5247874, variance = 5.5, nugget = 0.6932729, anisoRatio = 1, anisoAngleRadians = 0))


paramsBatch = t(apply(paramsBatch, 1, geostatsp::fillParam));    paramsBatch
paramsBatch = vclMatrix(cbind(paramsBatch, matrix(0, nrow(paramsBatch), 22-ncol(paramsBatch))),type="double")

betas<-vclMatrix(as.matrix(myres$summary[c("(Intercept)","cov1","cov2"),1]),type="double")

workgroupSize=c(64,16,16)
localSize = c(4,4,1)
NlocalCache=50


temp1=gpuRandom::likfitGpu(myres,mydat, type="double", 
                           paramsBatch,betas,form="loglik",minustwotimes=TRUE,workgroupSize,localSize, NlocalCache)
as.matrix(temp1)
#56.21288

# 72.85779
temp2=gpuRandom::likfitGpu(myres,mydat, type="double", 
                            paramsBatch,betas=NULL,form="ml",minustwotimes=TRUE,workgroupSize,localSize, NlocalCache)
as.matrix(temp2)
# #117.924
 temp3=gpuRandom::likfitGpu(myres,mydat, type="double", 
                             paramsBatch,betas,form="mlFixSigma",minustwotimes=TRUE,workgroupSize,localSize, NlocalCache)
 as.matrix(temp3)
# #50.17793
# 
# temp4=gpuRandom::likfitGpu(myres,mydat, type="double", 
#                            paramsBatch,betas=NULL,form="mlFixBeta",minustwotimes=TRUE,workgroupSize,localSize, NlocalCache)
# as.matrix(temp4)
# #60.14219
# 
# temp5=gpuRandom::likfitGpu(myres,mydat, type="double", 
#                            paramsBatch,betas=NULL,form="reml",minustwotimes=TRUE,workgroupSize,localSize, NlocalCache)
# as.matrix(temp5)
# #67.53707
# 
# temp6=gpuRandom::likfitGpu(myres,mydat, type="double", 
#                            paramsBatch,betas=NULL,form="remlPro",minustwotimes=TRUE,workgroupSize,localSize, NlocalCache)
# as.matrix(temp6)
#66.66792
```






```{r test_using_cpu_funtions, echo=FALSE, eval=FALSE}
ycpu<-mydat$Y
Xcpu<-as.matrix(cbind(c(rep(1, n)),mydat$cov1,mydat$cov2))
betas<-c(  -2.9630175,  0.6672477,  0.3847218)
betas<- c(-3.0552499, 0.6161210, 0.4188837)
tempcpu2<-ycpu-Xcpu%*%betas

# one batch parameters
paramsBatch = rbind(c(shape=1.25, range=0.2641423, variance = 1.5, nugget = 0, anisoRatio = 1, anisoAngleRadians = 0))
#paramsBatch = rbind(c(shape=3, range=11.5247874, variance = 5.5, nugget = 0.6932729, anisoRatio = 1, anisoAngleRadians = 0))
paramsBatch = t(apply(paramsBatch, 1, geostatsp::fillParam));    paramsBatch

materncpu = geostatsp::matern(
    x=mydat,
    param=drop(paramsBatch[1,1:7])
    )

cholCpu = as.matrix(chol(materncpu))
theDiag = diag(cholCpu)
L = cholCpu %*% diag(1/theDiag)
D = diag(theDiag^2)

# L<-as.matrix(Vbatch)
# library(gdata)
# upperTriangle(L, diag=FALSE, byrow=FALSE) <- 0
# diag(L)<-1

A<-solve(L, tempcpu2)

###C^T * D^(-1) * C
one0<-t(A)%*% solve(D) %*%A


#5, part1 = n*log(sigma^2)+log |D|
logD<-  sum(log(diag(D)))
#logD <- apply(log(D),1,sum)
part1 <-n*log(paramsBatch[,3]) + logD
    
#6,
loglik2 <- part1 + one0/paramsBatch[,3] + n*log(2*pi)


#

#72.85779
```







```{r test_using_another_example_Nov20,eval=T}
library('geostatsp')
data('swissRain')
sr2 = swissRain[1:20,]

# extract variables for modeling
sr2$sqrtY = sqrt(sr2$rain)
sr2$elev = raster::extract(swissAltitude, sr2)
dist(sr2@coords)
# build spatial model

swissFitIso = likfitLgm(
  data=sr2,
  formula=sqrtY ~ elev,
  param=c(range=500,shape=1,nugget=2.5),
  reml=FALSE,
  verbose=FALSE
)

swissFitIso$parameters

newParamList = list(
  range=seq(10000, 50000 , len=10),
  nugget = seq(0,1,len=10)
)
newParam= do.call(expand.grid, newParamList)

otherparams = c(shape=1, variance = 1.841, anisoRatio = 1, anisoAngleRadians = 0)
otherparams = matrix(rep(otherparams,each=nrow(newParam)),nrow=nrow(newParam))
colnames(otherparams) <- c("shape","variance", "anisoRatio", "anisoAngleRadians")

paramsBatch0 = cbind(newParam, otherparams)
paramsBatch0 = t(apply(paramsBatch0, 1, geostatsp::fillParam))
paramsBatch = vclMatrix(cbind(paramsBatch0, matrix(0, nrow(paramsBatch0), 22-ncol(paramsBatch0))),type="double")


workgroupSize=c(64,16,16)
localSize = c(4,4,1)
NlocalCache=500
 
temp=gpuRandom::likfitGpu(swissFitIso,sr2, type="double",paramsBatch,betas=NULL,form="ml",minustwotimes=TRUE,workgroupSize,localSize, NlocalCache)

tempcpu<-as.matrix(temp)

lMatrix = matrix(tempcpu, length(newParamList[[1]]), length(newParamList[[2]]))
# 
myCol = mapmisc::colourScale(lMatrix, breaks=8, dec=0)
image(
  newParamList[[1]]/1000, newParamList[[2]], lMatrix,
  col = myCol$col, breaks=myCol$breaks,
  xlab = names(newParamList)[1],
  ylab = names(newParamList)[2]
)
mapmisc::legendBreaks('topright', myCol)


```











