<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{loglikelihood_lgm}
-->


```{r test_preparation}
library(gpuR)
library(geostatsp)
n=40
mydat = SpatialPointsDataFrame(
	cbind(runif(n), seq(0,1,len=n)), 
	data=data.frame(cov1 = rnorm(n), cov2 = rpois(n, 0.5))
	)

# simulate a random field
trueParam = c(variance=2^2, range=0.35, shape=2, nugget=0.5^2)
set.seed(1)

mydat@data= cbind(mydat@data , RFsimulate(model=trueParam,x=mydat)@data)

# add fixed effects
mydat$Y = -3 + 0.5*mydat$cov1 + 0.2*mydat$cov2 + mydat$sim + rnorm(length(mydat), 0, sd=sqrt(trueParam["nugget"]))

library(sp)
spplot(mydat, "sim", col.regions=rainbow(10), main="U")
spplot(mydat, "Y", col.regions=rainbow(10), main="Y")


myres = likfitLgm(
	formula=Y ~ cov1 + cov2, 
	data=mydat, 
	param=c(range=0.1,nugget=0.1,shape=2), 
	paramToEstimate = c("range","nugget")
	)

myres$summary[,1:4]

# calculate likelihood
temp0=loglikLgm(param=myres$param, 
		data=mydat, 
		formula = Y ~ cov1 + cov2,
		reml=FALSE, minustwotimes=TRUE)
temp0

```


```{r test1}
# start here
y<-vclMatrix(as.matrix(mydat$Y),type="double")
X<-vclMatrix(as.matrix(cbind(c(rep(1, n)),mydat$cov1,mydat$cov2)),type="double")
coordsGpu<-vclMatrix(mydat@coords,type="double")
Paramsbatch = vclMatrix(as.matrix(expand.grid(
  shape = trueParam['shape'],
  range = trueParam['range'], 
  variance = trueParam['variance'],
  nugget = c(0.5^2,0.6^2,0.7^2,0.8^2)
)),type="double")

betas<-vclMatrix(as.matrix(myres$summary[c("(Intercept)","cov1","cov2"),1]),type="double")


Vbatch = vclMatrix(0, nrow(Paramsbatch)*nrow(y), nrow(y), type="double")
diagMat = vclMatrix(0, nrow(Paramsbatch), ncol(Vbatch), type = "double")
#Nglobal=c(16,16,4)
Nlocal = c(2,2,1)
NlocalCache=50

temp1=gpuRandom::likfitGpu0(y,X,coordsGpu,Paramsbatch,Vbatch,diagMat,betas,50,c(16,16,4),c(2,2,1))
temp1


```

