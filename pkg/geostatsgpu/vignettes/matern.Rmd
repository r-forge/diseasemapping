<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{Matern correlation}
-->

# Matern correlations

```{r packages}
library('geostatsp')
library('gpuR')
library('geostatsgpu')
```

Set up spatial data

```{r setupData}

Ngrid = c(100, 100)
Ngrid = c(50, 50)

coordsSp = sp::SpatialPoints(
	as.matrix(expand.grid(
	seq(1,by=1,len=Ngrid[2]), 
	seq(201,by=1,len=Ngrid[2]))))

myParams = c(shape=4.5, range=1.5, variance = 2, 
	nugget = 0, anisoRatio = 10, 
	anisoAngleRadians = pi/7)
```

Transfer coordinates to GPU and create matrix on GPU to hold the variance matrix
```{r gpuObjects}
coordsGpu = gpuR::vclMatrix(coordsSp@coords)

varMatGpu <- vclMatrix(
    data=-1, 
    length(coordsSp), length(coordsSp),
    type='double')
```

Create matern matrix on gpu
```{r maternMatGpu}
system.time(varCpu <- geostatsp::matern(coordsSp, myParams, type='variance'))
system.time(geostatsgpu:::maternGpuSI(x=coordsGpu, param=myParams, output=varMatGpu, type='variance'))
range(varCpu - as.matrix(varMatGpu))
```



```{r maternMatGpuChol}

cholVarGpu <- list(
    L = vclMatrix(
        data=-1, 
        length(coordsSp), length(coordsSp),
        type='double'),
    D = vclVector(data = -1, length=length(coordsSp), type='double')
    )

#devtools::document("..")
#devtools::install("..")
#devtools::reload("..")

system.time(cholVarCpu <- geostatsp::matern(coordsSp, myParams, type='cholesky'))
system.time(fromGpu <- geostatsgpu:::maternGpuSI(x=coordsGpu, param=myParams, output=cholVarGpu$L, DofLDL = cholVarGpu$D, type='cholesky'))

fromGpu$det 
sum(log(diag(cholVarCpu)))*2

library('Matrix')
ldlL = new('dtrMatrix', x=as.vector(as.matrix(cholVarGpu$L)), Dim = dim(cholVarGpu$L), uplo='L')
ldlD = Diagonal(ncol(cholVarGpu$L),as.vector(cholVarGpu$D))

cholL = ldlL %*% sqrt(ldlD)

ldlL[1:5,1:5]
cholL[1:5,1:5]
range(cholL- cholVarCpu)
```


```{r compare}
centreCell = 50*25+25

image(matrix(as.matrix(varMatGpu)[centreCell,],50,50))

image(matrix(as.matrix(varMatCpu)[centreCell,],50,50))


theTest = as.matrix(varMatGpu) - varMatCpu

which.max(as.matrix(varMatGpu)[2,] - varMatCpu[2,])

as.matrix(varMatGpu)[2,40:60]
as.matrix(varMatCpu)[2,40:60]

```

```{r }
cholVarGpu <- vclMatrix(
    data=-1, 
    nrow(coordsV), nrow(coordsV),
    type='double'
)

system.time(c1 <- maternGpu(coordsGpu, myParams, cholVarGpu, 'cholesky'))
system.time(cholVarCpu <- geostatsp::matern(coordsSp, 
	myParams, type='cholesky'))

as.matrix(cholVarGpu)[1:5,1:5]
as.matrix(cholVarCpu)[1:5,1:5]

```
