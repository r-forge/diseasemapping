<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{Matern correlations}
-->

```{r date}
date()
```

# Matern correlations

```{r packages}
library('geostatsp')
library('gpuR')
library('geostatsgpu')
```


Set up spatial data

```{r setupData}
# Ngrid = c(100, 100)
Ngrid = c(50, 50)

seqList = list( 
    x = seq(1,by=1,len=Ngrid[1]), 
    y = seq(201,by=1,len=Ngrid[2])
    )

coordsSp = sp::SpatialPoints(
	as.matrix(expand.grid(seqList$x, seqList$y)))

myParams = c(shape=4.5, range=1.5, variance = 2, 
	nugget = 0, anisoRatio = 10, 
	anisoAngleRadians = pi/7)
```

Transfer coordinates to GPU and create matrix on GPU to hold the variance matrix
```{r gpuObjects}
coordsGpu = vclMatrix(coordsSp@coords)

varMatGpu <- vclMatrix(
    data=-1, 
    length(coordsSp), length(coordsSp),
    type='double')
```

Create matern matrix on gpu
```{r maternMatGpu}
system.time(varCpu <- geostatsp::matern(coordsSp, myParams, type='variance'))
system.time(geostatsgpu::maternGpu(x=coordsGpu, param=myParams, output=varMatGpu, type='variance'))
range(varCpu - as.matrix(varMatGpu))
```

try cholesky
```{r chol}
myMat = varMatGpu
as.matrix(myMat)[1:5,1:5]
myMatR = as.matrix(myMat)
system.time(cholR <- chol(myMatR))
system.time(maternChol <- geostatsgpu:::cholGpu(myMat))
names(maternChol)
maternChol$logDet
as.vector(maternChol$D)[1:5]
diag(cholR)[1:5]^2
```
```{r cholRes}
LfromG = as.matrix(maternChol$L)
LfromG[1:7,1:5]
DfromR = diag(cholR)^2
LfromR = diag(1/sqrt(DfromR)) %*% cholR
LfromR[1:7,1:5]
LfromG[lower.tri(LfromG, diag=FALSE)]=0
Ldiff = LfromR - LfromG
Ldiff[1:9, 1:5]
range(Ldiff)
varRecon = t(LfromG) %*% diag(as.vector(maternChol$D)) %*% LfromG
NN = 450
range((varRecon - myMatR)[1:NN,1:NN])
```

```{r diagPlot}
plot(DfromR - as.vector(maternChol$D))
```


```{r devtools}
#Rcpp::compileAttributes('..')
#devtools::document("..")
#devtools::install("..")
#devtools::reload("..")
```

```{r maternMatGpuChol}
cholVarGpu <- list(
    L = vclMatrix(
        data=-1, 
        length(coordsSp), length(coordsSp),
        type='double'),
    D = vclVector(data = -1, length=length(coordsSp), type='double')
    )

system.time(cholVarCpu <- geostatsp::matern(coordsSp, myParams, type='cholesky'))
system.time(fromGpu <- geostatsgpu::maternGpu(x=coordsGpu, param=myParams, output=cholVarGpu$L, DofLDL = cholVarGpu$D, type='cholesky'))

fromGpu$det 
sum(log(diag(cholVarCpu)))*2
```

```{r checkChol}
library('Matrix')
ldlL = new('dtrMatrix', x=as.vector(as.matrix(cholVarGpu$L)), Dim = dim(cholVarGpu$L), uplo='L')
ldlD = Diagonal(ncol(cholVarGpu$L),as.vector(cholVarGpu$D))

cholL = as(ldlL %*% sqrt(ldlD), 'dtrMatrix')

ldlL[1:5,1:5]
cholL[1:5,1:5]
range(cholL- cholVarCpu)
```


```{r compare}
centreCell = floor(prod(Ngrid)/2)+floor(Ngrid[2]/2)

myCol = mapmisc::colourScale(c(0, myParams['variance']),
    breaks = 9, dec=1, style='equal', transform='sqrt')

image(
    seqList$x, seqList$y, 
    matrix(as.matrix(varMatGpu)[centreCell,],Ngrid[1],Ngrid[2]),
    col = myCol$col, breaks=myCol$breaks)
mapmisc::legendBreaks("bottomright", myCol)


image(
    seqList$x, seqList$y, 
 matrix(as.matrix(varCpu)[centreCell,],Ngrid[1],Ngrid[2]),
    col = myCol$col, breaks=myCol$breaks)
mapmisc::legendBreaks("bottomright", myCol)
```

# extra info

```{r gpuInfo, echo=TRUE}
gpuR::gpuInfo()
```
